<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ—…éŠè¨ˆç•«</title>
    <script>
        async function loadGoogleMaps() {
            try {
                let response = await fetch("/get_google_maps_key");
                let data = await response.json();
                let script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
                script.onload = initMap;  // ç¢ºä¿åœ°åœ–åœ¨è¼‰å…¥å¾Œåˆå§‹åŒ–
            } catch (error) {
                console.error("âŒ ç„¡æ³•è¼‰å…¥ Google Maps API:", error);
            }
        }

   
    </script>
</head>
<body>
    <h2>è¼¸å…¥å‡ºç™¼åœ°èˆ‡ç›®çš„åœ°</h2>
    <input id="start" type="text" placeholder="å‡ºç™¼åœ°">
    <input id="end" type="text" placeholder="ç›®çš„åœ°">
    <button onclick="planRoute()">è¦åŠƒè·¯ç·š</button>

    <h2>æ¨è–¦æ™¯é»</h2>
    <button onclick="fetchAttractions()">æŸ¥è©¢é™„è¿‘æ™¯é»</button>
    <ul id="attractionsList"></ul>

    <div id="map" style="width: 100%; height: 500px;"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let speedCameraMarkers = [];
        let attractionMarkers = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: { lat: 25.033964, lng: 121.564472 }
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
        }

        function planRoute() {
            let start = document.getElementById("start").value;
            let end = document.getElementById("end").value;

            if (!start || !end) {
                alert("è«‹è¼¸å…¥å‡ºç™¼åœ°å’Œç›®çš„åœ°ï¼");
                return;
            }

            let request = {
                origin: start,
                destination: end,
                travelMode: "DRIVING"
            };

            directionsService.route(request, function(result, status) {
                if (status == "OK") {
                    directionsRenderer.setDirections(result);
                    let routePoints = result.routes[0].overview_path.map(point => ({
                        lat: point.lat(),
                        lng: point.lng()
                    }));
                    fetchSpeedCameras(routePoints);
                } else {
                    alert("è·¯ç·šè¦åŠƒå¤±æ•—: " + status);
                }
            });
        }

        function fetchSpeedCameras(routePoints) {
            fetch("/get_speed_cameras/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() 
                },
                body: JSON.stringify({ route: routePoints })
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“¸ æ¸¬é€Ÿç…§ç›¸é»:", data);
                addSpeedCamerasToMap(data.cameras);
            })
            .catch(error => console.error("âŒ æ¸¬é€Ÿç›¸æ©Ÿ API éŒ¯èª¤:", error));
        }

        function addSpeedCamerasToMap(cameras) {
            speedCameraMarkers.forEach(marker => marker.setMap(null)); 
            speedCameraMarkers = [];

            cameras.forEach(cam => {
                let marker = new google.maps.Marker({
                    position: { lat: cam.latitude, lng: cam.longitude },
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    title: "æ¸¬é€Ÿç…§ç›¸é»"
                });
                speedCameraMarkers.push(marker);
            });
        }

        function fetchAttractions() {
            let end = document.getElementById("end").value;
            if (!end) {
                alert("è«‹å…ˆè¼¸å…¥ç›®çš„åœ°ï¼");
                return;
            }

            let geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: end }, function(results, status) {
                if (status === "OK") {
                    let location = results[0].geometry.location;
                    let lat = location.lat();
                    let lng = location.lng();

                    fetch(`/api/nearby_places?lat=${lat}&lng=${lng}&keyword=tourist attraction`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("ğŸ“ é™„è¿‘æ™¯é»:", data);
                        addAttractionsToMap(data.places);
                    })
                    .catch(error => console.error("âŒ æ™¯é» API éŒ¯èª¤:", error));
                } else {
                    alert("ç„¡æ³•è§£æç›®çš„åœ°: " + status);
                }
            });
        }

        function addAttractionsToMap(places) {
            attractionMarkers.forEach(marker => marker.setMap(null)); 
            attractionMarkers = [];
            let list = document.getElementById("attractionsList");
            list.innerHTML = "";

            places.forEach(place => {
                let marker = new google.maps.Marker({
                    position: { lat: place.geometry.location.lat, lng: place.geometry.location.lng },
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    title: place.name
                });
                attractionMarkers.push(marker);

                let li = document.createElement("li");
                li.textContent = place.name;
                list.appendChild(li);
            });
        }

        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = cookie.substring('csrftoken='.length, cookie.length);
                        break;
                    }
                }
            }
            return cookieValue;
        }


        window.onload = loadGoogleMaps;
    </script>
</body>
</html>