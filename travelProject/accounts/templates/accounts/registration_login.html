<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>整合登入/註冊/Google/Twilio 驗證</title>

    <style>
        /* ---------- 全域樣式 ---------- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            font-family: Arial, sans-serif;
            background: #2c2c2c; /* 深灰背景 */
            color: #fff;         /* 預設字色白 */
            display: flex;
            justify-content: center;
            align-items: center; /* 置中 */
        }

        /* ---------- 容器 ---------- */
        .container {
            background: #3a3a3a;        /* 較淺的深灰 */
            border-radius: 12px;        /* 圓角 */
            padding: 20px 25px;
            width: 360px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 16px;
            color: #fff;
        }

        /* ---------- 訊息容器 ---------- */
        #messageContainer {
            margin-bottom: 12px;
        }
        .msg-error {
            color: #f44336;   /* 紅色 */
            margin-bottom: 8px;
        }
        .msg-success {
            color: #4caf50;   /* 綠色 */
            margin-bottom: 8px;
        }

        /* 欄位錯誤容器 (每個欄位一個) */
        .field-error {
            color: #f44336;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        /* ---------- 表單元素 ---------- */
        form {
            display: flex;
            flex-direction: column;
        }
        label {
            margin: 8px 0 4px;
        }
        input, select {
            padding: 8px 10px;
            border: none;
            border-radius: 6px; /* 圓角 */
            margin-bottom: 12px;
            outline: none;
        }
        input[type="text"],
        input[type="password"] {
            background: #f9f9f9; /* 白底 */
            color: #333;         /* 深色文字 */
        }
        select {
            background: #f9f9f9;
            color: #333;
        }
        input::placeholder {
            color: #aaa;
        }

        /* ---------- 按鈕 ---------- */
        #submitBtn, #googleLoginBtn {
            background: #e0e0e0;      /* 淺灰 */
            color: #333;             /* 深色文字 */
            border: none;
            border-radius: 6px;      /* 圓角 */
            padding: 10px;
            margin-top: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        #submitBtn:hover,
        #googleLoginBtn:hover {
            background: #ccc;       /* hover 更深灰 */
        }

        /* ---------- 驗證碼區塊 ---------- */
        .verification-section {
            display: none; /* 預設隱藏 */
        }

        /* ---------- 平滑顯示「確認密碼」欄位 ---------- */
        .registration-field {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        .registration-field.active {
            max-height: 100px; /* 足以容納一個輸入框 */
            opacity: 1;
        }
    </style>
    <!-- Google Sign-In JS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="container">
        <h1>整合登入/註冊</h1>
        
        <!-- 新增訊息容器 -->
        <div id="messageContainer">
            <p class="msg-error"></p>
            <p class="msg-success"></p>
        </div>

        <!-- 除錯用：印出後端傳來的 show_verification 變數 -->
        <!-- <p style="font-size: 0.9rem; color: #ccc;">
            show_verification: {{ show_verification }}
        </p>
        <script>
            var showVerificationStr = "{{ show_verification|default:'false'|lower }}";
            var showVerification = (showVerificationStr === "true");
            console.log("showVerification:", showVerification);
        </script> -->

        <div id="formContainer">
            <form id="mainForm" method="post" action="{% url 'registration_login' %}">
                {% csrf_token %}
                <input type="hidden" name="step" id="step" value="initial">
                <input type="hidden" name="mode" id="mode" value="normal">
        
                <!-- 帳號 -->
                <label for="username">帳號 (Email)：</label>
                <input type="text" name="username" id="username" required placeholder="請輸入 Email">
                <div id="usernameInfo" style="color: #aaa;"></div>
                <!-- CHANGED: 新增欄位錯誤容器 -->
                <div id="usernameError" class="field-error"></div>
        
                <!-- 密碼 -->
                <label for="password">密碼：</label>
                <input type="password" name="password" id="password" required placeholder="請輸入密碼">
                <!-- CHANGED: 新增欄位錯誤容器 -->
                <div id="passwordError" class="field-error"></div>
        
                <!-- 確認密碼：若為註冊狀態才顯示 (帳號不存在) -->
                <div id="registrationFields" class="registration-field">
                    <label for="confirm_password">確認密碼：</label>
                    <input type="password" name="confirm_password" id="confirm_password" placeholder="再次輸入密碼">
                    <!-- CHANGED: 新增欄位錯誤容器 -->
                    <div id="confirm_passwordError" class="field-error"></div>
                </div>
        
                <!-- 手機號碼：國家下拉選單與本地號碼 -->
                <label for="country">國家：</label>
                <select id="country" name="country">
                    <option value="TW">台灣 (+886)</option>
                    <option value="US">美國 (+1)</option>
                    <option value="CN">中國 (+86)</option>
                    <option value="HK">香港 (+852)</option>
                    <option value="JP">日本 (+81)</option>
                    <option value="KR">韓國 (+82)</option>
                    <option value="GB">英國 (+44)</option>
                    <option value="CA">加拿大 (+1)</option>
                    <option value="AU">澳大利亞 (+61)</option>
                    <option value="DE">德國 (+49)</option>
                    <option value="FR">法國 (+33)</option>
                </select>
        
                <label for="phone_local">手機號碼：</label>
                <input type="text" id="phone_local" name="phone_local" required placeholder="例如 0912345678">
                <!-- CHANGED: 新增欄位錯誤容器 -->
                <div id="phone_localError" class="field-error"></div>
        
                <!-- 驗證碼：若後端回傳 show_verification=True，就顯示 -->
                <div id="verificationSection" class="verification-section">
                    <label for="code">驗證碼：</label>
                    <input type="text" name="code" id="code" placeholder="6位數驗證碼"><br>
                </div>
        
                <button type="submit" id="submitBtn">送出</button>
            </form>
        </div>
        
        <br>
        <button id="googleLoginBtn">使用 Google 登入</button>
    </div>

    <script>
        // CHANGED: 清空所有欄位錯誤
        function clearFieldErrors() {
            // 欄位列表：與上面 HTML 中的 name/id 對應
            const fields = ['username', 'password', 'confirm_password', 'phone_local'];
            fields.forEach(field => {
                let errDiv = document.getElementById(field + 'Error');
                if (errDiv) {
                    errDiv.innerText = '';
                }
            });

            // 同時也清空全域錯誤/成功訊息
            document.querySelector('.msg-error').innerText = '';
            document.querySelector('.msg-success').innerText = '';
        }

        // 監聽帳號欄位 blur 事件，檢查帳號是否已存在
        document.getElementById('username').addEventListener('blur', function() {
            var username = this.value.trim();
            if (username) {
                fetch("/accounts/check_username/?username=" + encodeURIComponent(username))
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        var regFields = document.getElementById('registrationFields');
                        var info = document.getElementById('usernameInfo');
                        if (data.exists) {
                            regFields.classList.remove('active');
                            info.style.color = '#e0e0e0';
                            info.innerText = '帳號已存在，請輸入密碼登入';
                            console.log("帳號存在，顯示登入模式");
                        } else {
                            regFields.classList.add('active');
                            info.style.color = '#e0e0e0';
                            info.innerText = '新帳號，請輸入密碼 & 確認密碼';
                            console.log("帳號不存在，顯示註冊模式");
                        }
                    })
                    .catch(function(e) {
                        console.error("檢查帳號時發生錯誤：", e);
                    });
            }
        });
    
        // 當頁面載入時，若後端要求顯示驗證碼欄位
        window.onload = function() {
            if (showVerification) {
                var codeField = document.getElementById('code');
                codeField.setAttribute('required', 'required');
                document.getElementById('verificationSection').style.display = 'block';
                document.getElementById('step').value = 'verify';
                console.log("顯示驗證碼欄位 (後端要求)");
            }
        };
    
        // Google 登入
        var googleLoginBtn = document.getElementById('googleLoginBtn');
        googleLoginBtn.addEventListener('click', function() {
            console.log("點擊了 Google 登入按鈕");
            window.google.accounts.id.initialize({
                client_id: '{{ GOOGLE_CLIENT_ID|default_if_none:"your_google_client_id" }}',
                callback: handleGoogleCallback
            });
            window.google.accounts.id.prompt(); // 彈出 Google 一鍵登入
        });

        function ajaxSubmitForm() {
            // CHANGED: 清除舊錯誤訊息
            clearFieldErrors();

            var form = document.getElementById('mainForm');
            var formData = new FormData(form);
        
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("AJAX 回應：", data);

                // (A) 若後端回傳錯誤
                if (data.error) {
                    // 若 data.error 是物件 => 逐欄位顯示
                    if (typeof data.error === 'object') {
                        for (let fieldName in data.error) {
                            let errorList = data.error[fieldName]; // 陣列
                            // 例如: [ { message: "請輸入有效的電子郵件地址", code: "invalid" } ]
                            let fieldDiv = document.getElementById(fieldName + 'Error');
                            if (fieldDiv) {
                                // 將多個錯誤訊息用換行或斜線串起來
                                let messages = errorList.map(err => err.message).join(' / ');
                                fieldDiv.innerText = messages;
                            }
                        }
                    } else {
                        // 如果是字串 => 顯示在全域錯誤訊息
                        document.querySelector('.msg-error').innerText = data.error;
                    }
                }

                // (B) 若有一般提示 message
                if (data.message) {
                    document.querySelector('.msg-success').innerText = data.message;
                }

                // (C) 若有成功 success
                if (data.success) {
                    document.querySelector('.msg-success').innerText = data.success;
                    // 例如：可以在這裡做頁面跳轉
                    // window.location.href = '/some-success-page/';
                }

                // (D) 若需要顯示驗證碼區塊
                if (data.show_verification) {
                    document.getElementById('code').setAttribute('required', 'required');
                    document.getElementById('verificationSection').style.display = 'block';
                    document.getElementById('step').value = 'verify';
                    // 更新按鈕文字為「驗證」
                    document.getElementById('submitBtn').innerText = '驗證';
                }
            })
            .catch(err => {
                console.error("表單提交錯誤：", err);
            });
        }
        
        // 攔截表單送出事件
        document.getElementById('mainForm').addEventListener('submit', function(e) {
            e.preventDefault();
            ajaxSubmitForm();
        });
        
        // Google 回呼
        function handleGoogleCallback(response) {
            console.log("Google callback response:", response);
            if (!response.credential) {
                document.querySelector('.msg-error').innerText = "Google 登入失敗，未取得 Token。";
                return;
            }
            document.getElementById('mode').value = 'google';
            var form = document.getElementById('mainForm');
            var tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = 'id_token';
            tokenInput.value = response.credential;
            form.appendChild(tokenInput);
            ajaxSubmitForm();
        }
    </script>
</body>
</html>
