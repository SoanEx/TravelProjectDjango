{% extends "base.html" %}
{% load static %}

{% block title %}æ—…éŠè¦åŠƒ{% endblock title %}

{% block content %}



<!-- (A) Loading å€å¡Šï¼šé¡¯ç¤ºã€Œè«‹ç¨å€™ã€ -->
<div id="loading" style="display:none; text-align:center; margin:10px; font-weight:bold;">
  è«‹ç¨å€™ï¼Œè³‡æ–™è¼‰å…¥ä¸­...
</div>

<!-- (B) Google åœ°åœ–é¡¯ç¤ºå€ -->
<div style="width: 100%; height: 500px;" id="map"></div>

<!-- (C) æŸ¥è©¢è¡¨å–®ï¼ˆå‡ºç™¼åœ°ã€ç›®çš„åœ°ã€æŒ‰éˆ•ï¼‰ -->
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-4">
      <label>å‡ºç™¼åœ°</label>
      <input id="start" type="text" class="form-control" placeholder="è¼¸å…¥å‡ºç™¼åœ°">
    </div>
    <div class="col-md-4">
      <label>ç›®çš„åœ°</label>
      <input id="end" type="text" class="form-control" placeholder="è¼¸å…¥ç›®çš„åœ°">
    </div>
    <div class="col-lg-4 col-md-6">
      <div class="form-group">
        <label class="fs-14 text-custom-white fw-600">å‡ºç™¼æ—¥æœŸ & æ™‚é–“</label>
        <input id="datetime" type="datetime-local" class="form-control">
      </div>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-12 d-flex justify-content-center gap-2">
      <button type="button" class="btn btn-primary" id="btn-plan-route">è¦åŠƒè·¯ç·š</button>
      <button type="button" class="btn btn-success" id="btn-attractions">æŸ¥è©¢æ™¯é»</button>
      <button type="button" class="btn btn-danger" id="btn-food">ğŸ½ ç¾é£Ÿ</button>
      <button type="button" class="btn btn-warning" id="btn-parking">ğŸš— åœè»Šå ´</button>
    </div>
  </div>
</div>

<!-- (D) å¤©æ°£è³‡è¨Š (é è¨­éš±è—) -->
<div class="container mt-5">
  <section id="weather-info" class="weather-info section-padding bg-light-white" style="display:none;">
    <div class="container">
      <div class="section-header text-center">
        <h3 class="text-custom-black">ç•¶åœ° <span class="text-custom">å¤©æ°£è³‡è¨Š</span></h3>
      </div>
      <div class="text-center">
        <p id="weather-datetime">ğŸ“… æ—¥æœŸæ™‚é–“ï¼š</p>
        <p id="weather-location">ğŸ“ åœ°é»ï¼š</p>
        <p id="weather-temp">ğŸŒ¡ æº«åº¦ï¼š</p>
        <p id="weather-desc">â˜ å¤©æ°£ç‹€æ³ï¼š</p>
        <p id="weather-humidity">ğŸ’§ æ¿•åº¦ï¼š</p>
        <p id="weather-wind">ğŸ’¨ é¢¨é€Ÿï¼š</p>
      </div>
    </div>
  </section>
</div>

<!-- (E) æ™¯é»è³‡è¨Š (é è¨­éš±è—) -->
<div class="container mt-5" id="attractions-section" style="display:none;">
  <h5>é™„è¿‘æ™¯é»è³‡è¨Š</h5>
  <ul id="attractionsList" style="display:flex; flex-wrap:wrap; gap:15px; list-style:none; padding:0;"></ul>
</div>

<!-- (F) ç¾é£Ÿè³‡è¨Š (é è¨­éš±è—) -->
<div class="container mt-5" id="food-section" style="display:none;">
  <h5>é™„è¿‘ç¾é£Ÿ</h5>
  <ul id="foodList" style="display:flex; flex-wrap:wrap; gap:15px; list-style:none; padding:0;"></ul>
</div>

<!-- (G) åœè»Šå ´è³‡è¨Š (é è¨­éš±è—) -->
<div class="container mt-5" id="parking-section" style="display:none;">
  <h5>é™„è¿‘åœè»Šå ´</h5>
  <ul id="parkingList" style="display:flex; flex-wrap:wrap; gap:15px; list-style:none; padding:0;"></ul>
</div>
{% endblock content %}

{% block scripts %}
<script>
  /* ============================
   * 0) Debug æ¨¡å¼
   * ============================ */
  const DEBUG = true;
  function debugLog(...args) {
    if (DEBUG) {
      console.log("[DEBUG]", ...args);
    }
  }

  /* ============================
   * å…¨åŸŸè®Šæ•¸
   * ============================ */
  let map;
  let directionsService;
  let directionsRenderer;

  let speedCameraMarkers = [];
  let attractionMarkers = [];
  let foodMarkers = [];
  let parkingMarkers = [];

  /* ============================
   * (A) è¼‰å…¥åœ°åœ–
   * ============================ */
  window.onload = loadGoogleMaps;
  async function loadGoogleMaps() {
    debugLog("loadGoogleMaps() start");
    try {
      showLoading();
      const res = await fetch("/get_google_maps_key");
      const data = await res.json();
      window.GOOGLE_API_KEY = data.apiKey;

      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
      script.onload = () => {
        debugLog("Google Maps JS è¼‰å…¥å®Œæˆï¼Œå‘¼å« initMap()");
        initMap();
      };
    } catch (error) {
      console.error("ç„¡æ³•è¼‰å…¥ Google Maps API:", error);
      hideLoading();
    }
  }

  function initMap() {
    debugLog("initMap() -> å»ºç«‹åœ°åœ–");
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 13,
      center: { lat: 25.033964, lng: 121.564472 }
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);
    hideLoading(); 
    debugLog("initMap() -> å®Œæˆåœ°åœ–åˆå§‹åŒ–");
  }

  /* ============================
   * (B) DOM äº‹ä»¶
   * ============================ */
  document.addEventListener("DOMContentLoaded", function() {
    debugLog("DOMContentLoaded -> ç¶å®šæŒ‰éˆ•äº‹ä»¶");
    document.getElementById("btn-plan-route").addEventListener("click", planRoute);
    document.getElementById("btn-attractions").addEventListener("click", () => {
      fetchAttractions();
    });
    document.getElementById("btn-food").addEventListener("click", fetchFood);
    document.getElementById("btn-parking").addEventListener("click", fetchParking);
    });
    document.querySelector(".btn-primary").addEventListener("click", function() {
      if (!validateDateTime()) return;  // è‹¥é©—è­‰å¤±æ•—å‰‡ä¸ç¹¼çºŒåŸ·è¡Œ
      planRoute();  // åŸ·è¡Œè¦åŠƒè·¯ç·š
    
  });

  /* ============================
   * (C) è¦åŠƒè·¯ç·š + æ¸¬é€Ÿç…§ç›¸
   * ============================ */
  function planRoute() {
    debugLog("planRoute() -> start");
    const start = document.getElementById("start").value.trim();
    const end = document.getElementById("end").value.trim();
    if (!start || !end) {
      alert("è«‹è¼¸å…¥å‡ºç™¼åœ°èˆ‡ç›®çš„åœ°ï¼");
      debugLog("planRoute() -> çµæŸ(ç„¡è¼¸å…¥)");
      return;
    }

    showLoading();
    const request = { origin: start, destination: end, travelMode: "DRIVING" };
    directionsService.route(request, function(result, status) {
      debugLog("planRoute() -> directionsService å›å‚³:", status);
      if (status === "OK") {
        directionsRenderer.setDirections(result);
        // å–å¾—è·¯ç·šåº§æ¨™
        const routePoints = result.routes[0].overview_path.map(p => ({
          lat: p.lat(),
          lng: p.lng()
        }));
        fetchSpeedCameras(routePoints);
      } else {
        alert("è·¯ç·šè¦åŠƒå¤±æ•—: " + status);
        hideLoading();
        debugLog("planRoute() -> å¤±æ•—:", status);
      }
    });
  }

  function fetchSpeedCameras(routePoints) {
    debugLog("fetchSpeedCameras() -> start", routePoints);
    fetch("/api/get_speed_cameras/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ route: routePoints })
    })
    .then(res => res.json())
    .then(data => {
      debugLog("fetchSpeedCameras() -> success, data:", data);
      addSpeedCamerasToMap(data.cameras || []);
      hideLoading();
    })
    .catch(err => {
      console.error("æ¸¬é€Ÿç›¸æ©Ÿ API éŒ¯èª¤:", err);
      hideLoading();
      debugLog("fetchSpeedCameras() -> error:", err);
    });
  }

  function addSpeedCamerasToMap(cameras) {
    debugLog("addSpeedCamerasToMap() -> ", cameras.length, "ç­†ç›¸æ©Ÿ");
    speedCameraMarkers.forEach(m => m.setMap(null));
    speedCameraMarkers = [];
    cameras.forEach(cam => {
      let marker = new google.maps.Marker({
        position: { lat: cam.latitude, lng: cam.longitude },
        map,
        icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        title: "æ¸¬é€Ÿç…§ç›¸"
      });
      speedCameraMarkers.push(marker);
    });
  }

  /* ============================
   * (D) æŸ¥è©¢æ™¯é»
   * ============================ */
  async function fetchAttractions() {
    debugLog("fetchAttractions() -> start");
    const end = document.getElementById("end").value.trim();
    if (!end) {
      alert("è«‹å…ˆè¼¸å…¥ç›®çš„åœ°ï¼");
      debugLog("fetchAttractions() -> çµæŸ(ç„¡è¼¸å…¥)");
      return;
    }
    showLoading();

    const geocoder = new google.maps.Geocoder();
    return new Promise((resolve, reject) => {
      geocoder.geocode({ address: end }, (results, status) => {
        debugLog("fetchAttractions() -> geocode å›å‚³:", status);
        if (status === "OK") {
          let loc = results[0].geometry.location;
          map.setCenter(loc);
          map.setZoom(14);

          // æ›´æ–°å¤©æ°£
          fetchWeatherInfo(loc.lat(), loc.lng());

          // å¾Œç«¯æŸ¥è©¢æ™¯é»
          fetch(`/api/nearby_places?lat=${loc.lat()}&lng=${loc.lng()}&keyword=tourist attraction`)
            .then(res => res.json())
            .then(data => {
              debugLog("fetchAttractions() -> API success:", data);
              addAttractionsToMapOneByOne(data.places || []);
              //debug
                debugLog("data.places æ˜¯ä»€éº¼ï¼Ÿ", data.places);
                debugLog("æ˜¯å¦ç‚ºé™£åˆ—ï¼Ÿ", Array.isArray(data.places));
                debugLog("é•·åº¦ï¼Ÿ", data.places ? data.places.length : "undefined");
              displayAttractionsOneByOne(data.places || []);
              hideLoading();
              resolve(true);
            })
            .catch(err => {
              console.error("æ™¯é» API éŒ¯èª¤:", err);
              debugLog("fetchAttractions() -> API error:", err);
              hideLoading();
              reject(err);
            });
        } else {
          alert("ç„¡æ³•è§£æç›®çš„åœ°: " + status);
          debugLog("fetchAttractions() -> geocodeå¤±æ•—:", status);
          hideLoading();
          reject(status);
        }
      });
    });
  }

  /* ä¸€ç­†ä¸€ç­†æ”¾Marker (æ™¯é») */
  async function addAttractionsToMapOneByOne(places) {
    debugLog("addAttractionsToMapOneByOne() -> placesæ•¸é‡:", places.length);
    attractionMarkers.forEach(m => m.setMap(null));
    attractionMarkers = [];

    for (let place of places) {
      let pos = place.geometry?.location;
      if (!pos) continue;

      let translatedName = await translateText(place.name || "ç„¡åç¨±");
      debugLog("addAttractionsToMapOneByOne() -> translatedName:", translatedName);

      let marker = new google.maps.Marker({
        position: pos,
        map,
        icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        title: translatedName
      });

      let apiKey = window.GOOGLE_API_KEY || "";
      let fallbackImage = "{% static 'images/no-image-dark-large.png' %}";
      let photoUrl = (place.photos && place.photos.length > 0)
        ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
        : fallbackImage;
      let infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="text-align:center;">
            <img src="${photoUrl}" alt="${translatedName}" style="width:100px;height:100px;border-radius:8px;">
            <br>
            <strong>
              <a href="https://www.google.com/search?q=${encodeURIComponent(translatedName)}" target="_blank">
                ${translatedName}
              </a>
            </strong>
          </div>
        `
      });
      marker.addListener("click", () => infoWindow.open(map, marker));
      attractionMarkers.push(marker);
    }
  }

    function showElement(id) {
    const el = document.getElementById(id);
    if (!el) return;
    
    el.classList.remove("d-none");
    el.hidden = false;
    el.style.display = "block";
    }

  /* ä¸€ç­†ä¸€ç­†é¡¯ç¤ºåˆ—è¡¨ (æ™¯é») */
  async function displayAttractionsOneByOne(places) {
    console.log("ğŸ“Œ é¡¯ç¤ºæ™¯é»æ•¸é‡:", places.length);
    const section = document.getElementById("attractions-section");
    const list = document.getElementById("attractionsList");
    list.innerHTML = "";

    if (!places || places.length === 0) {
      console.log("ğŸš« æ²’æœ‰æ™¯é»è³‡æ–™ï¼Œéš±è—å€å¡Š");
      section.style.display = "none";
      return;
    }
    

    for (let i = 0; i < places.length; i++) {
      if (i === 0) {
      section.style.display = "block"; // double confirm
      }
      const place = places[i];
      debugLog(`[${i}] è™•ç†æ™¯é»ï¼š`, place);
      let translatedName = await translateText(place.name || "ç„¡åç¨±");
      debugLog(`[${i}] ç¿»è­¯å¾Œåç¨±ï¼š`, translatedName);
      let address = place.vicinity || "åœ°å€ä¸è©³";
      let rating = place.rating ? `â­ ${place.rating}` : "â­ ç„¡è©•åˆ†";
      let openNow = place.opening_hours
        ? (place.opening_hours.open_now ? "ğŸŸ¢ ç‡Ÿæ¥­ä¸­" : "ğŸ”´ å·²é—œé–€")
        : "â³ æœªæä¾›";
      let apiKey = window.GOOGLE_API_KEY || "";
      let fallbackImage = "{% static 'images/no-image-dark-large.png' %}";
      let photoUrl = (place.photos && place.photos.length > 0)
        ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
        : fallbackImage;
      let googleUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)}`;

      let li = document.createElement("li");
      li.style.flex = "1 1 calc(33% - 10px)";
      li.style.maxWidth = "400px";
      li.style.minWidth = "280px";
      li.style.boxShadow = "0px 2px 10px rgba(0,0,0,0.1)";
      li.style.borderRadius = "8px";
      li.style.overflow = "hidden";

      li.innerHTML = `
        <a href="${googleUrl}" target="_blank">
          <img src="${photoUrl}" alt="${translatedName}" style="width:100%;height:180px;object-fit:cover;">
        </a>
        <div style="padding:15px; text-align:center;">
          <h5 style="margin:0;color:#007bff;">
            <a href="${googleUrl}" target="_blank" style="text-decoration:none;color:#007bff;">
              ${translatedName}
            </a>
          </h5>
          <p style="margin:5px 0; color:#555;">${address}</p>
          <p style="margin:5px 0; color:#555;">${rating}</p>
          <p style="margin:5px 0; color:#555;">${openNow}</p>
        </div>
      `;
      list.appendChild(li);
      debugLog(`[${i}] appendChild å®Œæˆ`);
    }
  }
  showElement("attractions-section");

//   function showAttractions() {
//     debugLog("showAttractions() -> check list children");
//     const section = document.getElementById("attractions-section");
//     const list = document.getElementById("attractionsList");
//     section.style.display = (list.children.length > 0) ? "block" : "none";
//   }

  /* ============================
   * (E) æŸ¥è©¢ç¾é£Ÿ
   * ============================ */
  function fetchFood() {
    debugLog("fetchFood() -> start");
    const end = document.getElementById("end").value.trim();
    if (!end) {
      alert("è«‹å…ˆè¼¸å…¥ç›®çš„åœ°ï¼");
      debugLog("fetchFood() -> çµæŸ(ç„¡è¼¸å…¥)");
      return;
    }
    showLoading();

    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: end }, (results, status) => {
      debugLog("fetchFood() -> geocode å›å‚³:", status);
      if (status === "OK") {
        let loc = results[0].geometry.location;
        map.setCenter(loc);
        map.setZoom(14);

        foodMarkers.forEach(m => m.setMap(null));
        foodMarkers = [];
        const section = document.getElementById("food-section");
        const list = document.getElementById("foodList");
        list.innerHTML = "";

        fetch(`/api/nearby_places?lat=${loc.lat()}&lng=${loc.lng()}&keyword=restaurant`)
          .then(res => res.json())
          .then(async data => {
            debugLog("fetchFood() -> success data:", data);
            let places = data.places || [];
            if (places.length === 0) {
              alert("æ²’æœ‰æ‰¾åˆ°ç¾é£Ÿï¼");
              section.style.display = "none";
              hideLoading();
              return;
            }
            for (let place of places) {
              let translatedName = await translateText(place.name || "ç„¡åç¨±");
              displayFoodSingle(place, translatedName);
              addFoodToMapSingle(place, translatedName);
            }
            section.style.display = "block";

            fetchWeatherInfo(loc.lat(), loc.lng());
            hideLoading();
          })
          .catch(err => {
            console.error("ç¾é£Ÿ API éŒ¯èª¤:", err);
            debugLog("fetchFood() -> error:", err);
            hideLoading();
          });
      } else {
        alert("ç„¡æ³•è§£æç›®çš„åœ°: " + status);
        debugLog("fetchFood() -> geocodeå¤±æ•—:", status);
        hideLoading();
      }
    });
  }

  /* åœ¨åˆ—è¡¨é¡¯ç¤ºå–®ç­†ç¾é£Ÿ */
  function displayFoodSingle(place, translatedName) {
    debugLog("displayFoodSingle() -> place:", place.name, ", translatedName:", translatedName);
    const list = document.getElementById("foodList");
    let address = place.vicinity || "åœ°å€ä¸è©³";
    let rating = place.rating ? `â­ ${place.rating}` : "â­ ç„¡è©•åˆ†";
    let googleUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} é¤å»³`;

    let apiKey = window.GOOGLE_API_KEY || "";
    let photoUrl = (place.photos && place.photos.length > 0)
      ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
      : "https://via.placeholder.com/400?text=No+Image";

    let li = document.createElement("li");
    li.style.flex = "1 1 calc(33% - 10px)";
    li.style.maxWidth = "400px";
    li.style.minWidth = "280px";
    li.style.boxShadow = "0px 2px 10px rgba(0,0,0,0.1)";
    li.style.borderRadius = "8px";
    li.style.overflow = "hidden";

    li.innerHTML = `
      <a href="${googleUrl}" target="_blank">
        <img src="${photoUrl}" alt="${translatedName}" style="width:100%; height:180px; object-fit:cover;">
      </a>
      <div style="padding:15px;text-align:center;">
        <h5 style="margin:0;color:#dc3545;">${translatedName}</h5>
        <p style="margin:5px 0;color:#555;">${address}</p>
        <p style="margin:5px 0;color:#555;">${rating}</p>
      </div>
    `;
    list.appendChild(li);
  }

  /* åœ¨åœ°åœ–é¡¯ç¤ºå–®ç­†ç¾é£Ÿ */
  function addFoodToMapSingle(place, translatedName) {
    debugLog("addFoodToMapSingle() ->", place.name, translatedName);
    let pos = place.geometry?.location;
    if (!pos) return;

    let marker = new google.maps.Marker({
      position: pos,
      map,
      icon: "https://maps.google.com/mapfiles/ms/icons/orange-dot.png",
      title: translatedName
    });

    let apiKey = window.GOOGLE_API_KEY || "";
    let photoUrl = (place.photos && place.photos.length > 0)
      ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
      : "https://via.placeholder.com/100?text=No+Image";
    let googleUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} é¤å»³`;

    let infoWindow = new google.maps.InfoWindow({
      content: `
        <div style="text-align:center;">
          <a href="${googleUrl}" target="_blank">
            <img src="${photoUrl}" alt="${translatedName}" style="width:100px;height:100px;border-radius:8px;">
          </a>
          <br>
          <strong><a href="${googleUrl}" target="_blank">${translatedName}</a></strong>
        </div>
      `
    });
    marker.addListener("click", () => infoWindow.open(map, marker));
    foodMarkers.push(marker);
  }

  /* ============================
   * (F) æŸ¥è©¢åœè»Šå ´
   * ============================ */
  function fetchParking() {
    debugLog("fetchParking() -> start");
    const end = document.getElementById("end").value.trim();
    if (!end) {
      alert("è«‹å…ˆè¼¸å…¥ç›®çš„åœ°ï¼");
      debugLog("fetchParking() -> çµæŸ(ç„¡è¼¸å…¥)");
      return;
    }
    showLoading();

    let geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: end }, (results, status) => {
      debugLog("fetchParking() -> geocode å›å‚³:", status);
      if (status === "OK") {
        let loc = results[0].geometry.location;
        map.setCenter(loc);
        map.setZoom(15);

        // æ›´æ–°å¤©æ°£
        fetchWeatherInfo(loc.lat(), loc.lng());

        fetch(`/api/nearby_places?lat=${loc.lat()}&lng=${loc.lng()}&keyword=parking`)
          .then(res => res.json())
          .then(async data => {
            debugLog("fetchParking() -> success data:", data);
            let places = data.places || [];
            addParkingToMapOneByOne(places);
            displayParkingOneByOne(places);
            hideLoading();
          })
          .catch(err => {
            console.error("åœè»Šå ´ API éŒ¯èª¤:", err);
            debugLog("fetchParking() -> error:", err);
            hideLoading();
          });
      } else {
        alert("ç„¡æ³•è§£æç›®çš„åœ°: " + status);
        debugLog("fetchParking() -> geocodeå¤±æ•—:", status);
        hideLoading();
      }
    });
  }

  /* ä¸€ç­†ä¸€ç­†æ”¾ Marker (åœè»Šå ´) */
  async function addParkingToMapOneByOne(places) {
    debugLog("addParkingToMapOneByOne() -> placesæ•¸é‡:", places.length);
    parkingMarkers.forEach(m => m.setMap(null));
    parkingMarkers = [];

    let bounds = new google.maps.LatLngBounds();
    for (let place of places) {
      let pos = place.geometry?.location;
      if (!pos) continue;

      let translatedName = await translateText(place.name || "ç„¡åç¨±");
      debugLog("addParkingToMapOneByOne() -> name:", translatedName);

      let marker = new google.maps.Marker({
        position: pos,
        map,
        icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        title: translatedName
      });

      let apiKey = window.GOOGLE_API_KEY || "";
      let photoUrl = (place.photos && place.photos.length > 0)
        ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
        : "https://via.placeholder.com/100?text=No+Image";
      let googleUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} åœè»Šå ´`;

      let infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="text-align:center;">
            <a href="${googleUrl}" target="_blank">
              <img src="${photoUrl}" alt="${translatedName}" style="width:100px;height:100px;border-radius:8px;">
            </a>
            <br>
            <strong><a href="${googleUrl}" target="_blank">${translatedName}</a></strong>
          </div>
        `
      });
      marker.addListener("click", () => infoWindow.open(map, marker));
      parkingMarkers.push(marker);
      bounds.extend(pos);
    }
    if (places.length > 0) {
      map.fitBounds(bounds);
    }
  }

  /* ä¸€ç­†ä¸€ç­†é¡¯ç¤º (åœè»Šå ´) */
  async function displayParkingOneByOne(places) {
    debugLog("displayParkingOneByOne() -> placesæ•¸é‡:", places.length);
    const section = document.getElementById("parking-section");
    const list = document.getElementById("parkingList");
    list.innerHTML = "";

    if (!places || places.length === 0) {
      section.style.display = "none";
      return;
    }
    section.style.display = "block";

    for (let place of places) {
      let originalName = place.name || "ç„¡åç¨±";
      let translatedName = await translateText(originalName);
      let address = place.vicinity || "åœ°å€ä¸è©³";
      let rating = place.rating ? `â­ ${place.rating}` : "â­ ç„¡è©•åˆ†";

      let apiKey = window.GOOGLE_API_KEY || "";
      let photoUrl = (place.photos && place.photos.length > 0)
        ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
        : "https://via.placeholder.com/400?text=No+Image";
      let googleUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} åœè»Šå ´`;

      let li = document.createElement("li");
      li.style.flex = "1 1 calc(33% - 10px)";
      li.style.maxWidth = "400px";
      li.style.minWidth = "280px";
      li.style.boxShadow = "0px 2px 10px rgba(0,0,0,0.1)";
      li.style.borderRadius = "8px";
      li.style.overflow = "hidden";

      li.innerHTML = `
        <a href="${googleUrl}" target="_blank">
          <img src="${photoUrl}" alt="${translatedName}" style="width:100%;height:180px;object-fit:cover;">
        </a>
        <div style="padding:15px;text-align:center;">
          <h5 style="margin:0;color:#007bff;">
            <a href="${googleUrl}" target="_blank" style="text-decoration:none;color:#007bff;">
              ${translatedName}
            </a>
          </h5>
          <p style="margin:5px 0;color:#555;">${address}</p>
          <p style="margin:5px 0;color:#555;">${rating}</p>
        </div>
      `;
      list.appendChild(li);
    }
  }

  /* ============================
   * (G) å¤©æ°£æŸ¥è©¢
   * ============================ */
   async function fetchWeatherInfo(lat, lng) {
    console.log("ğŸ” fetchWeatherInfo() -> ", lat, lng);

    // 1ï¸âƒ£ ç¢ºä¿ `#weather-info` å­˜åœ¨ï¼Œä¸¦ **å…ˆéš±è—**
    const weatherInfo = document.getElementById("weather-info");
    if (!weatherInfo) return;
    weatherInfo.style.display = "none";  // ğŸš€ æŸ¥è©¢å‰å…ˆéš±è—

    // 2ï¸âƒ£ å–å¾—ä½¿ç”¨è€…è¼¸å…¥çš„ **æ—¥æœŸ & æ™‚é–“**
    let dateTimeInput = document.getElementById("datetime").value;
    if (!dateTimeInput) {
        alert("âš  è«‹é¸æ“‡æŸ¥è©¢æ—¥æœŸèˆ‡æ™‚é–“ï¼");
        return;
    }

    // 3ï¸âƒ£ **é è¨­é¡¯ç¤ºã€Œè¼‰å…¥ä¸­ã€**
    document.getElementById("weather-datetime").textContent = "ğŸ“… æ—¥æœŸæ™‚é–“ï¼šè¼‰å…¥ä¸­...";
    document.getElementById("weather-location").textContent = "ğŸ“ åœ°é»ï¼šè¼‰å…¥ä¸­...";
    document.getElementById("weather-temp").textContent = "ğŸŒ¡ æº«åº¦ï¼šè¼‰å…¥ä¸­...";
    document.getElementById("weather-desc").textContent = "â˜ å¤©æ°£ç‹€æ³ï¼šè¼‰å…¥ä¸­...";
    document.getElementById("weather-humidity").textContent = "ğŸ’§ æ¿•åº¦ï¼šè¼‰å…¥ä¸­...";
    document.getElementById("weather-wind").textContent = "ğŸ’¨ é¢¨é€Ÿï¼šè¼‰å…¥ä¸­...";

    try {
        // 4ï¸âƒ£ **ç™¼é€ API è«‹æ±‚**
        let response = await fetch(`/api/weather/?lat=${lat}&lon=${lng}&datetime=${dateTimeInput}`);
        let data = await response.json();

        if (data.error) {
            alert(`âŒ å¤©æ°£ API éŒ¯èª¤ï¼š${data.error}`);
            return;
        }

        console.log("âœ… æˆåŠŸç²å–å¤©æ°£è³‡æ–™:", data);

        // **å°‡ T æ›¿æ›ç‚º ç©ºæ ¼**
        let formattedDateTime = data.datetime.replace("T", " ");

        // 5ï¸âƒ£ **æ›´æ–°å¤©æ°£è³‡è¨Š**
        document.getElementById("weather-datetime").textContent = `ğŸ“… æ—¥æœŸæ™‚é–“ï¼š${formattedDateTime}`;
        document.getElementById("weather-location").textContent = `ğŸ“ åœ°é»ï¼š${data.location}`;
        document.getElementById("weather-temp").textContent = `ğŸŒ¡ æº«åº¦ï¼š${data.temperature}Â°C`;
        document.getElementById("weather-desc").textContent = `â˜ å¤©æ°£ç‹€æ³ï¼š${data.description}`;
        document.getElementById("weather-humidity").textContent = `ğŸ’§ æ¿•åº¦ï¼š${data.humidity}%`;
        document.getElementById("weather-wind").textContent = `ğŸ’¨ é¢¨é€Ÿï¼š${data.wind_speed} m/s`;

        // 6ï¸âƒ£ **æŸ¥è©¢æˆåŠŸå¾Œé¡¯ç¤ºå¤©æ°£è³‡è¨Š**
        weatherInfo.style.display = "block";
        
    } catch (error) {
        console.error("âŒ å¤©æ°£ API ç™¼ç”ŸéŒ¯èª¤:", error);
        alert("âš  å–å¾—å¤©æ°£è³‡è¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
    }
}

  /* ============================
   * (H) ç¿»è­¯ API (å–®ç­†)
   * ============================ */
  async function translateText(text, targetLang = "zh-TW") {
    debugLog("translateText() -> start:", text);
    try {
      const res = await fetch(`/api/translate/?text=${encodeURIComponent(text)}&target=${targetLang}`);
      const data = await res.json();
      debugLog("translateText() -> success, translatedText:", data.translatedText);
      return data.translatedText || text;
    } catch (err) {
      console.error("ç¿»è­¯ API éŒ¯èª¤:", err);
      debugLog("translateText() -> error fallback, return original text:", text);
      return text; // fallbackï¼šå¤±æ•—æ™‚é¡¯ç¤ºåŸæ–‡
    }
  }
  
  /* ============================
   * (I) æª¢æŸ¥è¼¸å…¥æ™‚é–“
   * ============================ */
  function validateDateTime() {
    let dateTimeInput = document.getElementById("datetime").value;
    let selectedTime = new Date(dateTimeInput);
    let now = new Date(); // å–å¾—ç¾åœ¨æ™‚é–“

    if (selectedTime <= now) {
        alert("è¼¸å…¥æ™‚é–“å°æ–¼ç¾åœ¨æ™‚é–“ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼");
        return false;  // ç¦æ­¢ç¹¼çºŒåŸ·è¡Œ
    }
    return true;
}

  /* ============================
   * (J) CSRF Token
   * ============================ */
  function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith('csrftoken=')) {
          cookieValue = cookie.substring('csrftoken='.length, cookie.length);
          break;
        }
      }
    }
    return cookieValue;
  }

  /* ============================
   * (K) Loading UI
   * ============================ */
  function showLoading() {
    debugLog("showLoading() -> é¡¯ç¤ºè¼‰å…¥æç¤º");
    document.getElementById("loading").style.display = "block";
  }
  function hideLoading() {
    debugLog("hideLoading() -> éš±è—è¼‰å…¥æç¤º");
    document.getElementById("loading").style.display = "none";
  }

</script>

{% endblock scripts %}
