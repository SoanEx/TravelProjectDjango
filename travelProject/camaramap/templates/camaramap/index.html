{% extends "base.html" %}
{% load static %}

{% block title %}æ—…éŠè¦åŠƒ{% endblock title %}

{% block content %}
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="keywords" content="#">
    <meta name="description" content="#">
    <title>Car Dealer html5  Bootstrap Template  | Homepage</title>
    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="{% static 'assets/images/map_images/favicon.ico' %}">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{% static 'assets/images/map_images/favicon.ico' %}">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{% static 'assets/images/map_images/favicon.ico' %}">
    <link rel="apple-touch-icon-precomposed" href="{% static 'assets/images/map_images/favicon.ico' %}">
    <link rel="shortcut icon" href="{% static 'assets/images/map_images/favicon.png' %}">
    <!-- Bootstrap -->
    <link href="{% static 'assets/css/map_css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Fontawesome -->
    <link href="{% static 'assets/css/map_css/font-awesome.css' %}" rel="stylesheet">
    <!-- Flaticons -->
    <link href="{% static 'assets/css/map_css/font/flaticon.css' %}" rel="stylesheet">
    <!-- Slick Slider -->
    <link href="{% static 'assets/css/map_css/slick.css' %}" rel="stylesheet">
    <!-- Range Slider -->
    <link href="{% static 'assets/css/map_css/ion.rangeSlider.min.css' %}" rel="stylesheet">
    <!-- Datepicker -->
    <link href="{% static 'assets/css/map_css/datepicker.css' %}" rel="stylesheet">
    <!-- magnific popup -->
    <link href="{% static 'assets/css/map_css/magnific-popup.css' %}" rel="stylesheet">
    <!-- Nice Select -->
    <link href="{% static 'assets/css/map_css/nice-select.css' %}" rel="stylesheet">
    <!-- Custom Stylesheet -->
    <link href="{% static 'assets/css/map_css/style.css' %}" rel="stylesheet">
    <!-- Custom Responsive -->
    <link href="{% static 'assets/css/map_css/responsive.css' %}" rel="stylesheet">
  
    <!-- CSS for IE -->
    <!--[if lte IE 9]>
            <link rel="stylesheet" type="text/css" href="css/ie.css" />
        <![endif]-->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
          <script type='text/javascript' src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
          <script type='text/javascript' src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js"></script>
        <![endif]-->
    <!-- place -->
    <style>
        
        /* é è¨­éš±è—æ™¯é» & åœè»Šå ´è³‡è¨Šå€å¡Šï¼ˆæ¨™é¡Œ & å…§å®¹ï¼‰ */
        #attractions-section, #parking-section {
          display: none;
        }
        /* é è¨­éš±è—æ™¯é» & åœè»Šå ´è³‡è¨Š */
        #attractionsList,
        #parkingList {
            display: none;
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            max-height: none !important; /* å–æ¶ˆæœ€å¤§é«˜åº¦ */
            height: auto !important;  /* è®“å…§å®¹æ ¹æ“šå¯¦éš›å¤§å°æ“´å±• */
            overflow: visible !important; /* å–æ¶ˆæ»¾å‹•æ¢ */
        }
        
        /* æ™¯é» & åœè»Šå ´é …ç›®æ¨£å¼ */
        .attraction-item, .parking-item {
            display: flex;
            flex-direction: column;
            width: 280px;
            background: #fff;
            border-radius: 10px;
            overflow: auto;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        /* æ»‘é¼ æ‡¸åœæ”¾å¤§ */
        .attraction-item:hover, .parking-item:hover {
          transform: scale(1.05);
        }
        /* åœ–ç‰‡æ¨£å¼ */
        .attraction-img, .parking-img {
          width: 100%;
          height: 180px;
          object-fit: cover;
        }


        /* æ™¯é»è³‡è¨Šå€å¡Š */
        .attraction-info, .parking-info {
          padding: 15px;
        }

        .attraction-info h3 {
            margin: 0;
            font-size: 1.1em;
            color: #007bff;
        }

        .attraction-info p {
            margin: 5px 0;
            color: #555;
        }
        /* é è¨­éš±è—å¤©æ°£è³‡è¨Š */
        .weather-info {
            display: none;  
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        body {
          overflow: auto !important;
        }
        
    </style>
    <meta charset="UTF-8">
    <title>æ—…éŠè¨ˆç•«</title>
    <script>
        async function loadGoogleMaps() {
            try {
                let response = await fetch("/get_google_maps_key");
                let data = await response.json();
                
                // âœ… **ç¢ºä¿ API Key å­˜å…¥å…¨åŸŸè®Šæ•¸**
                window.GOOGLE_API_KEY = data.apiKey;
        
                let script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
                script.onload = initMap;  // ç¢ºä¿åœ°åœ–è¼‰å…¥å¾Œåˆå§‹åŒ–
            } catch (error) {
                console.error("âŒ ç„¡æ³•è¼‰å…¥ Google Maps API:", error);
            }
        }
    </script>
</head>
<body>
  
     <!-- Start Topbar -->
  <header class="header">
    <div class="topbar bg-theme">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 col-md-5">
            <div class="leftside">
              <ul class="custom-flex">
                <li> <a href="#" class="text-custom-white"><i class="fab fa-facebook-f"></i></a> </li>
                <li> <a href="#" class="text-custom-white"><i class="fab fa-twitter"></i></a> </li>
                <li> <a href="#" class="text-custom-white"><i class="fab fa-instagram"></i></a> </li>
                <li> <a href="#" class="text-custom-white"><i class="fab fa-linkedin"></i></a> </li>
              </ul>
            </div>
          </div>
          <div class="col-lg-6 col-md-7">
            <div class="rightside full-height">
              <ul class="custom-flex full-height">
                <li class="book-appointment"> <a href="booking.html"> Booking Now </a> </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation-wrapper">
      <div class="container">
        <div class="row">
          <div class="col-12">
          </div>
        </div>
      </div>
    </div>
  </header>
  <!-- End Topbar -->
  <!-- Header -->
<!-- Start Slider (è®Šæ›´ç‚º Google åœ°åœ–) -->
<div class="slider p-relative">
  <div class="main-banner">
    <div id="map" style="width: 100%; height: 500px;"></div>
  </div>
</div>
<!-- End Slider -->
 <!-- Start Banner tabs (ä¿®æ”¹ç‚ºè¼¸å…¥å‡ºç™¼åœ° & ç›®çš„åœ° + æŸ¥è©¢æŒ‰éˆ•) -->
<div class="container">
  <div class="banner-tabs">
    <div class="row">
      <div class="col-12">
        <div class="tabs">
          <div class="tab-content">
            <div class="tab-pane active" id="search">
              <div class="tab-inner">
                <form>
                  <div class="row">
                    <div class="col-lg-4 col-md-6">
                      <div class="form-group">
                        <label class="fs-14 text-custom-white fw-600">å‡ºç™¼åœ°</label>
                        <input id="start" type="text" class="form-control" placeholder="è¼¸å…¥å‡ºç™¼åœ°">
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                      <div class="form-group">
                        <label class="fs-14 text-custom-white fw-600">ç›®çš„åœ°</label>
                        <input id="end" type="text" class="form-control" placeholder="è¼¸å…¥ç›®çš„åœ°">
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-12 text-center">
                      <button type="button" class="btn btn-primary" onclick="planRoute()">è¦åŠƒè·¯ç·š</button>
                      <button type="button" class="btn btn-success" onclick="fetchAttractions()">æŸ¥è©¢æ™¯é»</button>
                      <button type="button" class="btn btn-warning" onclick="fetchParking()">ğŸš— åœè»Šå ´</button>
                    </div>
                  </div>
                </form>
              </div> <!-- tab-inner -->
            </div> <!-- tab-pane -->
          </div> <!-- tab-content -->
        </div> <!-- tabs -->
      </div> <!-- col-12 -->
    </div> <!-- row -->
  </div> <!-- banner-tabs -->
</div> <!-- container -->
<!-- End Banner Tabs -->
  <!-- Start Our work -->
 <!-- Start å¤©æ°£è³‡è¨Š -->
 <section id="weather-info" class="weather-info section-padding bg-light-white">
  <div class="container">
    <div class="section-header text-center">
      <h3 class="text-custom-black">ç•¶åœ° <span class="text-custom">å¤©æ°£è³‡è¨Š</span></h3>
    </div>
    <div class="text-center">
      <p id="weather-location">ğŸ“ åœ°é»ï¼š</p>
      <p id="weather-temp">ğŸŒ¡ æº«åº¦ï¼š</p>
      <p id="weather-desc">â˜ å¤©æ°£ç‹€æ³ï¼š</p>
      <p id="weather-humidity">ğŸ’§ æ¿•åº¦ï¼š</p>
      <p id="weather-wind">ğŸ’¨ é¢¨é€Ÿï¼š</p>
    </div>
  </div>
</section>
<!-- End å¤©æ°£è³‡è¨Š -->
<!-- Start Our Work (æ”¹ç‚ºé¡¯ç¤ºæ™¯é» & åœè»Šå ´è³‡è¨Š) -->
<!-- æ™¯é» & åœè»Šå ´è³‡è¨Š -->
<section id="attractions-section" class="section-padding our-work-sec bg-light-white">
  <div class="container">
    <div class="section-header text-center">
      <h3 class="text-custom-black">é™„è¿‘<span class="text-custom">æ™¯é»è³‡è¨Š</span></h3>
    </div>
    <div class="row">
      <div class="col-12">
        <ul id="attractionsList"></ul>
      </div>
    </div>
  </div>
</section>

<section id="parking-section" class="section-padding our-work-sec bg-light-white" style="display: none;">
  <div class="container">
    <div class="section-header text-left">  <!-- âœ… ä¿®æ”¹ç‚º text-left è®“æ¨™é¡Œé å·¦ -->
      <h3 class="text-custom-black">ğŸš— é™„è¿‘ <span class="text-custom">åœè»Šå ´</span></h3>
    </div>
    <div class="row">
      <div class="col-12">
        <ul id="parkingList"></ul>
      </div>
    </div>
  </div>
</section>

{% endblock content %}
<!-- End Our Work -->
{% block scripts %}
  <!-- End Our work -->
    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let speedCameraMarkers = [];
        let attractionMarkers = [];
        let parkingMarkers = [];
              
                document.addEventListener("DOMContentLoaded", function() {
                document.body.style.overflow = "auto";  // ç¢ºä¿é é¢è¼‰å…¥æ™‚å¯ä»¥æ»¾å‹•
            });
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: { lat: 25.033964, lng: 121.564472 } // ğŸ”¹ é è¨­ä¸­å¿ƒé»ï¼ˆè‹¥ç„¡æ³•ç²å–ä½ç½®æ™‚ä½¿ç”¨ï¼‰
            });
        
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
        
        }

        function planRoute() {
            let start = document.getElementById("start").value;
            let end = document.getElementById("end").value;

            if (!start || !end) {
                alert("è«‹è¼¸å…¥å‡ºç™¼åœ°å’Œç›®çš„åœ°ï¼");
                return;
            }

            let request = {
                origin: start,
                destination: end,
                travelMode: "DRIVING"
            };

            directionsService.route(request, function(result, status) {
                if (status == "OK") {
                    directionsRenderer.setDirections(result);
                    let routePoints = result.routes[0].overview_path.map(point => ({
                        lat: point.lat(),
                        lng: point.lng()
                    }));
                    fetchSpeedCameras(routePoints);
                } else {
                    alert("è·¯ç·šè¦åŠƒå¤±æ•—: " + status);
                }
            });
        }

        function fetchSpeedCameras(routePoints) {
            fetch("/api/get_speed_cameras/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() 
                },
                body: JSON.stringify({ route: routePoints })
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“¸ æ¸¬é€Ÿç…§ç›¸é»:", data);
                addSpeedCamerasToMap(data.cameras);
            })
            .catch(error => console.error("âŒ æ¸¬é€Ÿç›¸æ©Ÿ API éŒ¯èª¤:", error));
        }

        function addSpeedCamerasToMap(cameras) {
            speedCameraMarkers.forEach(marker => marker.setMap(null)); 
            speedCameraMarkers = [];

            cameras.forEach(cam => {
                let marker = new google.maps.Marker({
                    position: { lat: cam.latitude, lng: cam.longitude },
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    title: "æ¸¬é€Ÿç…§ç›¸é»"
                });
                speedCameraMarkers.push(marker);
            });
        }

        async function fetchAttractions() {
            // **ç›´æ¥å¾å¾Œç«¯ç²å– API Key**
            if (!window.GOOGLE_API_KEY) {
                console.warn("â³ Google API Key å°šæœªè¼‰å…¥ï¼Œæ­£åœ¨å–å¾—...");
                await loadGoogleAPIKey();  // âœ… ç¢ºä¿ API Key æ­£ç¢ºè¼‰å…¥
            }
        
            let end = document.getElementById("end").value;
            if (!end) {
                alert("è«‹å…ˆè¼¸å…¥ç›®çš„åœ°ï¼");
                return;
            }
        
            let geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: end }, function(results, status) {
                if (status === "OK") {
                    let location = results[0].geometry.location;
                    let lat = location.lat();
                    let lng = location.lng();
                     // ğŸ”„ **æœå°‹æ™¯é»å¾Œé¡¯ç¤ºç•¶åœ°å¤©æ°£**
                    fetchWeatherInfo(lat, lng);
        
                    fetch(`/api/nearby_places?lat=${lat}&lng=${lng}&keyword=tourist attraction`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("ğŸ“ é™„è¿‘æ™¯é» API å›æ‡‰:", data);
        
                        if (data.error) {
                            alert(`âŒ API éŒ¯èª¤: ${data.error}`);
                            return;
                        }
        
                        if (data.places && data.places.length > 0) {
                            addAttractionsToMap(data.places);
                            displayAttractions(data.places);
                        } else {
                            alert("ğŸš¨ ç„¡æ³•ç²å–æ™¯é»è³‡è¨Šï¼");
                        }
                    })
                    .catch(error => console.error("âŒ æ™¯é» API éŒ¯èª¤:", error));
                } else {
                    alert("ç„¡æ³•è§£æç›®çš„åœ°: " + status);
                }
            });
        }


        // **æ™¯é»é¡¯ç¤º**
        async function displayAttractions(places) {
            let list = document.getElementById("attractionsList");
            list.innerHTML = ""; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
        
            if (!places || places.length === 0) {
                console.log("ğŸš¨ æ²’æœ‰æ™¯é»è³‡æ–™ï¼Œéš±è—æ™¯é»å€å¡Š");
                document.getElementById("attractions-section").style.display = "none";
                  return;
              }

            console.log("âœ… é¡¯ç¤ºæ™¯é»æ•¸é‡:", places.length);  // âœ… ç¢ºèªæ˜¯å¦æœ‰è³‡æ–™
            
            document.getElementById("attractions-section").style.display = "block";  // âœ… é¡¯ç¤ºæ™¯é»å€å¡Š
            document.getElementById("attractionsList").style.display = "flex";  // âœ… é¡¯ç¤ºæ™¯é»åˆ—è¡¨
            
            for (const place of places) {
                let originalName = place.name || "ç„¡åç¨±";
                let translatedName = await translateText(originalName, "zh-TW");  // **ç¿»è­¯æˆä¸­æ–‡**
                let address = place.vicinity || "åœ°å€ä¸è©³";
                let rating = place.rating ? `â­ ${place.rating}` : "â­ ç„¡è©•åˆ†";
                let openingHours = place.opening_hours ? 
                    (place.opening_hours.open_now ? "ğŸŸ¢ ç‡Ÿæ¥­ä¸­" : "ğŸ”´ å·²é—œé–€") : "â³ æœªæä¾›ç‡Ÿæ¥­æ™‚é–“";
        
                // âœ… **ä½¿ç”¨ Google æœå°‹ URLï¼ˆæ”¯æ´ä¸­æ–‡åç¨±ï¼‰**
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)}`;
        
                // âœ… **ç²å–æ™¯é»ç¸®åœ–**
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/400?text=No+Image";
        
                // âœ… **HTML çµæ§‹**
                let li = document.createElement("li");
                li.classList.add("attraction-item");
                li.innerHTML = `
                    <a href="${googleSearchUrl}" target="_blank">
                        <img src="${photoUrl}" alt="${translatedName}" class="attraction-img">
                    </a>
                    <div class="attraction-info">
                        <h3>
                            <a href="${googleSearchUrl}" target="_blank" style="text-decoration: none; color: #007bff;">
                                ${translatedName} <!-- ç¢ºä¿é¡¯ç¤ºç¿»è­¯å¾Œçš„ä¸­æ–‡åç¨± -->
                            </a>
                        </h3>
                        <p>${address}</p>
                        <p>${rating}</p>
                        <p>${openingHours}</p>
                    </div>
                `;
        
                list.appendChild(li);
            }
        }


        async function addAttractionsToMap(places) {
            attractionMarkers.forEach(marker => marker.setMap(null));
            attractionMarkers = [];
        
            for (const place of places) {
                let position = { lat: place.geometry.location.lat, lng: place.geometry.location.lng };
                let originalName = place.name || "ç„¡åç¨±";
                let translatedName = await translateText(originalName, "zh-TW");  // **ç¿»è­¯æˆä¸­æ–‡**
        
                let marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    title: translatedName
                });
        
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/100?text=No+Image";
        
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)}`;
        
                let infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center;">
                            <img src="${photoUrl}" alt="${translatedName}" style="width: 100px; height: 100px; border-radius: 8px;">
                            <br>
                            <strong>
                                <a href="${googleSearchUrl}" target="_blank">${translatedName}</a>
                            </strong>
                        </div>
                    `
                });
        
                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });
        
                infoWindow.open(map, marker);
                attractionMarkers.push(marker);
            }
        }

        async function fetchParking() {
            let end = document.getElementById("end").value;
            if (!end) {
                alert("è«‹å…ˆè¼¸å…¥ç›®çš„åœ°ï¼");
                return;
            }
        
            let geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: end }, function (results, status) {
                if (status === "OK") {
                    let location = results[0].geometry.location;
                    let lat = location.lat();
                    let lng = location.lng();
                    
                    // ğŸ”„ **æœå°‹åœè»Šå ´å¾Œé¡¯ç¤ºç•¶åœ°å¤©æ°£**
                    fetchWeatherInfo(lat, lng);
                    
                    // **ğŸ”„ è®“åœ°åœ–ç§»å‹•åˆ°æœå°‹çš„ä¸­å¿ƒé»**
                    map.setCenter({ lat: lat, lng: lng });
                    map.setZoom(15); // èª¿æ•´é©ç•¶çš„ç¸®æ”¾ç´šåˆ¥
        
                    fetch(`/api/nearby_places?lat=${lat}&lng=${lng}&keyword=parking`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("ğŸ…¿ï¸ é™„è¿‘åœè»Šå ´ API å›æ‡‰:", data);
        
                            if (data.error) {
                                alert(`âŒ API éŒ¯èª¤: ${data.error}`);
                                return;
                            }
        
                            if (data.places && data.places.length > 0) {
                                addParkingToMap(data.places);
                                displayParking(data.places);
                            } else {
                                alert("ğŸš¨ æ²’æœ‰æ‰¾åˆ°é™„è¿‘çš„åœè»Šå ´ï¼");
                            }
                        })
                        .catch(error => console.error("âŒ åœè»Šå ´ API éŒ¯èª¤:", error));
                } else {
                    alert("ç„¡æ³•è§£æç›®çš„åœ°: " + status);
                }
            });
        }
        
        // ğŸ…¿ï¸ **åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºåœè»Šå ´ï¼ˆèˆ‡æ™¯é»ç›¸åŒæ ¼å¼ï¼‰**
        async function addParkingToMap(places, centerLat, centerLng) {
             // âœ… æ¸…é™¤èˆŠçš„æ¨™è¨˜ï¼ˆç¢ºä¿è®Šæ•¸å·²å®šç¾©ï¼‰
            if (!Array.isArray(parkingMarkers)) {
                parkingMarkers = [];
            }

            parkingMarkers.forEach(marker => marker.setMap(null));
            parkingMarkers = [];
        
            let bounds = new google.maps.LatLngBounds(); // ğŸ“ è®“åœ°åœ–é©æ‡‰æ‰€æœ‰æ¨™è¨˜
        
            for (const place of places) {
                let position = place.geometry?.location;
                if (!position || !position.lat || !position.lng) {
                    console.warn("âš ï¸ ç„¡æ•ˆçš„åœè»Šå ´ä½ç½®:", place);
                    continue;  // è·³ééŒ¯èª¤çš„è³‡æ–™
                }
        
                let translatedName = await translateText(place.name || "ç„¡åç¨±", "zh-TW");
        
                let marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
                    title: translatedName
                });
        
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/100?text=No+Image";
        
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} åœè»Šå ´`;
        
                let infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center;">
                            <a href="${googleSearchUrl}" target="_blank">
                                <img src="${photoUrl}" alt="${translatedName}" style="width: 100px; height: 100px; border-radius: 8px;">
                            </a>
                            <br>
                            <strong>
                                <a href="${googleSearchUrl}" target="_blank">${translatedName}</a>
                            </strong>
                        </div>
                    `
                });
        
                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });
        
                parkingMarkers.push(marker);
                bounds.extend(position); // ğŸ“ æ“´å±•åœ°åœ–é‚Šç•Œä»¥åŒ…å«æ¨™è¨˜
            }
        
            // ğŸ“Œ **ç¢ºä¿åœ°åœ–èª¿æ•´è‡³é©åˆçš„ç¸®æ”¾ç´šåˆ¥**
            if (places.length > 0) {
                map.fitBounds(bounds);
            } else {
                map.setCenter({ lat: centerLat, lng: centerLng });
                map.setZoom(15);
            }
        }
        
        // ğŸ…¿ï¸ **åœ¨åˆ—è¡¨é¡¯ç¤ºåœè»Šå ´è³‡è¨Šï¼ˆèˆ‡æ™¯é»ç›¸åŒæ ¼å¼ï¼‰**
        async function displayParking(places) {
          let parkingSection = document.getElementById("parking-section");  // å–å¾—åœè»Šå ´å€å¡Š
          let parkingList = document.getElementById("parkingList");  // å–å¾—åœè»Šå ´åˆ—è¡¨
      
          // âœ… æ¸…ç©ºèˆŠçš„åœè»Šå ´è³‡è¨Š
          parkingList.innerHTML = "";
      
          // âœ… å¦‚æœæ²’æœ‰åœè»Šå ´è³‡è¨Šï¼Œéš±è—å€å¡Š & çµæŸå‡½å¼
          if (!places || places.length === 0) {
            parkingSection.style.display = "none";  // ğŸ”¹ ç¢ºä¿æœå°‹æ™¯é»æ™‚ä¸å½±éŸ¿é¡¯ç¤ºç‹€æ…‹
            return;
        }
      
          // âœ… æœ‰åœè»Šå ´è³‡è¨Šæ™‚ï¼Œé¡¯ç¤ºå€å¡Š
          parkingSection.style.display = "block";
      
          // ğŸ”¹ ä¾åºåŠ å…¥åœè»Šå ´è³‡è¨Š
          for (const place of places) {
              let originalName = place.name || "ç„¡åç¨±";
              let translatedName = await translateText(originalName, "zh-TW");
              let address = place.vicinity || "åœ°å€ä¸è©³";
              let rating = place.rating ? `â­ ${place.rating}` : "â­ ç„¡è©•åˆ†";
      
              let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} åœè»Šå ´`;
      
              let apiKey = window.GOOGLE_API_KEY || "";
              let photoUrl = place.photos && place.photos.length > 0
                  ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                  : "https://via.placeholder.com/400?text=No+Image";
      
              let li = document.createElement("li");
              li.classList.add("attraction-item");
              li.innerHTML = `
                  <a href="${googleSearchUrl}" target="_blank">
                      <img src="${photoUrl}" alt="${translatedName}" class="attraction-img">
                  </a>
                  <div class="attraction-info">
                      <h3>
                          <a href="${googleSearchUrl}" target="_blank" style="text-decoration: none; color: #007bff;">
                              ${translatedName}
                          </a>
                      </h3>
                      <p>${address}</p>
                      <p>${rating}</p>
                  </div>
              `;
      
              parkingList.appendChild(li);
          }
      }
        function showAttractions() {
          let attractionsSection = document.getElementById("attractions-section");
          let attractionsList = document.getElementById("attractionsList");
      
          if (attractionsList.children.length > 0) {  
              attractionsSection.style.display = "block";  // âœ… æœ‰è³‡æ–™æ‰é¡¯ç¤ºæ™¯é»å€å¡Š
          } else {
              attractionsSection.style.display = "none";  // âŒ æ²’æœ‰è³‡æ–™æ™‚éš±è—
          }
        }
      
        function showParking() {
            let parkingSection = document.getElementById("parking-section");
            let parkingList = document.getElementById("parkingList");
        
            if (parkingList.children.length > 0) {  
                parkingSection.style.display = "block";  // âœ… æœ‰è³‡æ–™æ‰é¡¯ç¤ºåœè»Šå ´å€å¡Š
            } else {
                parkingSection.style.display = "none";  // âŒ æ²’æœ‰è³‡æ–™æ™‚éš±è—
            }
        }
        
        // **é»æ“Šã€ŒæŸ¥è©¢æ™¯é»ã€æ™‚**
            document.querySelector(".btn-success").addEventListener("click", function () {
            fetchAttractions().then(() => {
                showAttractions();  // âœ… åªæœ‰æ™¯é»æœ‰è³‡æ–™æ‰é¡¯ç¤º
            });
        });
        
        // **é»æ“Šã€Œé¡¯ç¤ºåœè»Šå ´ã€æ™‚**
            document.querySelector(".btn-warning").addEventListener("click", function () {
            fetchParking().then(() => {
                showParking();  // âœ… åªæœ‰åœè»Šå ´æœ‰è³‡æ–™æ‰é¡¯ç¤º
            });
        });


        function fetchWeatherInfo(lat, lon) {
          console.log(`âœ… å‘¼å« fetchWeatherInfo(${lat}, ${lon})`);
          let weatherContainer = document.getElementById("weather-info");
          if (!weatherContainer) {
              console.error("âŒ æ‰¾ä¸åˆ° #weather-info å€å¡Šï¼");
              return;
          }
        
            // **âœ… é»æ“Šå¾Œæ‰é¡¯ç¤ºå¤©æ°£è³‡è¨Šå€å¡Š**
            weatherContainer.style.display = "block";
        
            // **âœ… é¡¯ç¤ºã€Œè¼‰å…¥ä¸­...ã€ï¼Œä½†ä¸åŒ…å«é è¨­åœ°é»**
            document.getElementById("weather-location").textContent = `ğŸ“ åœ°é»ï¼šè¼‰å…¥ä¸­...`;
            document.getElementById("weather-temp").textContent = `ğŸŒ¡ æº«åº¦ï¼šè¼‰å…¥ä¸­...`;
            document.getElementById("weather-desc").textContent = `â˜ å¤©æ°£ç‹€æ³ï¼šè¼‰å…¥ä¸­...`;
            document.getElementById("weather-humidity").textContent = `ğŸ’§ æ¿•åº¦ï¼šè¼‰å…¥ä¸­...`;
            document.getElementById("weather-wind").textContent = `ğŸ’¨ é¢¨é€Ÿï¼šè¼‰å…¥ä¸­...`;
            
            fetch(`/api/weather/?lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error("âŒ ç„¡æ³•ç²å–å¤©æ°£è³‡è¨Š:", data.error);
                        return;
                    }
        
                    // **âœ… æ›´æ–°å¤©æ°£è³‡è¨Š**
                    document.getElementById("weather-location").textContent = `ğŸ“ åœ°é»ï¼š${data.location}`;
                    document.getElementById("weather-temp").textContent = `ğŸŒ¡ æº«åº¦ï¼š${data.temperature}Â°C`;
                    document.getElementById("weather-desc").textContent = `â˜ å¤©æ°£ç‹€æ³ï¼š${data.description}`;
                    document.getElementById("weather-humidity").textContent = `ğŸ’§ æ¿•åº¦ï¼š${data.humidity}%`;
                    document.getElementById("weather-wind").textContent = `ğŸ’¨ é¢¨é€Ÿï¼š${data.wind_speed} m/s`;
                })
                .catch(error => console.error("âŒ å¤©æ°£ API éŒ¯èª¤:", error));
        }
        


                // **åç¨±ç¿»è­¯**
        async function translateText(text, targetLang = "zh-TW") {
            const response = await fetch(`/api/translate?text=${encodeURIComponent(text)}&target=${targetLang}`);
            const data = await response.json();
            return data.translatedText || text;  // é é˜² API å¤±æ•—æ™‚ï¼Œä»é¡¯ç¤ºåŸå§‹åç¨±
        }

        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = cookie.substring('csrftoken='.length, cookie.length);
                        break;
                    }
                }
            }
            return cookieValue;
        }


        window.onload = loadGoogleMaps;

    </script>
        <!-- Place all Scripts Here -->
    <!-- jQuery -->
    <script src="{% static 'assets/js/map_js/jquery.min.js' %}"></script>
    <!-- Popper -->
    <script src="{% static 'assets/js/map_js/popper.min.js' %}"></script>
    <!-- Bootstrap -->
    <script src="{% static 'assets/js/map_js/bootstrap.min.js' %}"></script>
    <!-- Range Slider -->
    <script src="{% static 'assets/js/map_js/ion.rangeSlider.min.js' %}"></script>
    <!-- Slick Slider -->
    <script src="{% static 'assets/js/map_js/slick.min.js' %}"></script>
    <!-- Datepicker -->
    <script src="{% static 'assets/js/map_js/datepicker.js' %}"></script>
    <script src="{% static 'assets/js/map_js/datepicker.en.js' %}"></script>
    <!-- Isotope Gallery -->
    <script src="{% static 'assets/js/map_js/isotope.pkgd.min.js' %}"></script>
    <!-- Nice Select -->
    <script src="{% static 'assets/js/map_js/jquery.nice-select.js' %}"></script>
    <!-- magnific popup -->
    <script src="{% static 'assets/js/map_js/jquery.magnific-popup.min.js' %}"></script>
    <!-- Custom Js -->
    <script src="{% static 'assets/js/map_js/custom.js' %}"></script>
    <!-- /Place all Scripts Here -->

{% endblock scripts %}