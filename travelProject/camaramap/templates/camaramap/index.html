<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <style>
        #attractionsList {
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .attraction-item {
            display: flex;
            flex-direction: column;
            width: 280px;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .attraction-item:hover {
            transform: scale(1.05);
        }

        .attraction-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .attraction-info {
            padding: 15px;
        }

        .attraction-info h3 {
            margin: 0;
            font-size: 1.1em;
            color: #007bff;
        }

        .attraction-info p {
            margin: 5px 0;
            color: #555;
        }
    </style>
    <meta charset="UTF-8">
    <title>旅遊計畫</title>
    <script>
        async function loadGoogleMaps() {
            try {
                let response = await fetch("/get_google_maps_key");
                let data = await response.json();
                
                // ✅ **確保 API Key 存入全域變數**
                window.GOOGLE_API_KEY = data.apiKey;
        
                let script = document.createElement("script");
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
                script.onload = initMap;  // 確保地圖載入後初始化
            } catch (error) {
                console.error("❌ 無法載入 Google Maps API:", error);
            }
        }
    </script>
</head>
<body>
    <h2>輸入出發地與目的地</h2>
    <input id="start" type="text" placeholder="出發地">
    <input id="end" type="text" placeholder="目的地">
    <button onclick="planRoute()">規劃路線</button>

<h2>推薦景點</h2>
<button onclick="fetchAttractions()">查詢附近景點</button>
<button onclick="fetchParking()">🚗 顯示附近停車場</button>
<ul id="attractionsList"></ul>

    <div id="map" style="width: 100%; height: 500px;"></div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let speedCameraMarkers = [];
        let attractionMarkers = [];
        let parkingMarkers = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: { lat: 25.033964, lng: 121.564472 }
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
        }

        function planRoute() {
            let start = document.getElementById("start").value;
            let end = document.getElementById("end").value;

            if (!start || !end) {
                alert("請輸入出發地和目的地！");
                return;
            }

            let request = {
                origin: start,
                destination: end,
                travelMode: "DRIVING"
            };

            directionsService.route(request, function(result, status) {
                if (status == "OK") {
                    directionsRenderer.setDirections(result);
                    let routePoints = result.routes[0].overview_path.map(point => ({
                        lat: point.lat(),
                        lng: point.lng()
                    }));
                    fetchSpeedCameras(routePoints);
                } else {
                    alert("路線規劃失敗: " + status);
                }
            });
        }

        function fetchSpeedCameras(routePoints) {
            fetch("/api/get_speed_cameras/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() 
                },
                body: JSON.stringify({ route: routePoints })
            })
            .then(response => response.json())
            .then(data => {
                console.log("📸 測速照相點:", data);
                addSpeedCamerasToMap(data.cameras);
            })
            .catch(error => console.error("❌ 測速相機 API 錯誤:", error));
        }

        function addSpeedCamerasToMap(cameras) {
            speedCameraMarkers.forEach(marker => marker.setMap(null)); 
            speedCameraMarkers = [];

            cameras.forEach(cam => {
                let marker = new google.maps.Marker({
                    position: { lat: cam.latitude, lng: cam.longitude },
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    title: "測速照相點"
                });
                speedCameraMarkers.push(marker);
            });
        }

        async function fetchAttractions() {
            // **直接從後端獲取 API Key**
            if (!window.GOOGLE_API_KEY) {
                console.warn("⏳ Google API Key 尚未載入，正在取得...");
                await loadGoogleAPIKey();  // ✅ 確保 API Key 正確載入
            }
        
            let end = document.getElementById("end").value;
            if (!end) {
                alert("請先輸入目的地！");
                return;
            }
        
            let geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: end }, function(results, status) {
                if (status === "OK") {
                    let location = results[0].geometry.location;
                    let lat = location.lat();
                    let lng = location.lng();
        
                    fetch(`/api/nearby_places?lat=${lat}&lng=${lng}&keyword=tourist attraction`)
                    .then(response => response.json())
                    .then(data => {
                        console.log("📍 附近景點 API 回應:", data);
        
                        if (data.error) {
                            alert(`❌ API 錯誤: ${data.error}`);
                            return;
                        }
        
                        if (data.places && data.places.length > 0) {
                            addAttractionsToMap(data.places);
                            displayAttractions(data.places);
                        } else {
                            alert("🚨 無法獲取景點資訊！");
                        }
                    })
                    .catch(error => console.error("❌ 景點 API 錯誤:", error));
                } else {
                    alert("無法解析目的地: " + status);
                }
            });
        }



        // **景點顯示**
        async function displayAttractions(places) {
            let list = document.getElementById("attractionsList");
            list.innerHTML = ""; // 清空現有列表
        
            if (!places || places.length === 0) {
                list.innerHTML = "<p>🚫 沒有找到景點，請更換地點再試。</p>";
                return;
            }
        
            console.log("✅ 正在顯示景點數量:", places.length);
            
            for (const place of places) {
                let originalName = place.name || "無名稱";
                let translatedName = await translateText(originalName, "zh-TW");  // **翻譯成中文**
                let address = place.vicinity || "地址不詳";
                let rating = place.rating ? `⭐ ${place.rating}` : "⭐ 無評分";
                let openingHours = place.opening_hours ? 
                    (place.opening_hours.open_now ? "🟢 營業中" : "🔴 已關門") : "⏳ 未提供營業時間";
        
                // ✅ **使用 Google 搜尋 URL（支援中文名稱）**
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)}`;
        
                // ✅ **獲取景點縮圖**
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/400?text=No+Image";
        
                // ✅ **HTML 結構**
                let li = document.createElement("li");
                li.classList.add("attraction-item");
                li.innerHTML = `
                    <a href="${googleSearchUrl}" target="_blank">
                        <img src="${photoUrl}" alt="${translatedName}" class="attraction-img">
                    </a>
                    <div class="attraction-info">
                        <h3>
                            <a href="${googleSearchUrl}" target="_blank" style="text-decoration: none; color: #007bff;">
                                ${translatedName} <!-- 確保顯示翻譯後的中文名稱 -->
                            </a>
                        </h3>
                        <p>${address}</p>
                        <p>${rating}</p>
                        <p>${openingHours}</p>
                    </div>
                `;
        
                list.appendChild(li);
            }
        }


        async function addAttractionsToMap(places) {
            attractionMarkers.forEach(marker => marker.setMap(null));
            attractionMarkers = [];
        
            for (const place of places) {
                let position = { lat: place.geometry.location.lat, lng: place.geometry.location.lng };
                let originalName = place.name || "無名稱";
                let translatedName = await translateText(originalName, "zh-TW");  // **翻譯成中文**
        
                let marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    title: translatedName
                });
        
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/100?text=No+Image";
        
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)}`;
        
                let infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center;">
                            <img src="${photoUrl}" alt="${translatedName}" style="width: 100px; height: 100px; border-radius: 8px;">
                            <br>
                            <strong>
                                <a href="${googleSearchUrl}" target="_blank">${translatedName}</a>
                            </strong>
                        </div>
                    `
                });
        
                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });
        
                infoWindow.open(map, marker);
                attractionMarkers.push(marker);
            }
        }

        async function fetchParking() {
            let end = document.getElementById("end").value;
            if (!end) {
                alert("請先輸入目的地！");
                return;
            }
        
            let geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: end }, function (results, status) {
                if (status === "OK") {
                    let location = results[0].geometry.location;
                    let lat = location.lat();
                    let lng = location.lng();
                    
                    // **🔄 讓地圖移動到搜尋的中心點**
                    map.setCenter({ lat: lat, lng: lng });
                    map.setZoom(15); // 調整適當的縮放級別
        
                    fetch(`/api/nearby_places?lat=${lat}&lng=${lng}&keyword=parking`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("🅿️ 附近停車場 API 回應:", data);
        
                            if (data.error) {
                                alert(`❌ API 錯誤: ${data.error}`);
                                return;
                            }
        
                            if (data.places && data.places.length > 0) {
                                addParkingToMap(data.places);
                                displayParking(data.places);
                            } else {
                                alert("🚨 沒有找到附近的停車場！");
                            }
                        })
                        .catch(error => console.error("❌ 停車場 API 錯誤:", error));
                } else {
                    alert("無法解析目的地: " + status);
                }
            });
        }
        
        // 🅿️ **在地圖上顯示停車場（與景點相同格式）**
        async function addParkingToMap(places, centerLat, centerLng) {
             // ✅ 清除舊的標記（確保變數已定義）
            if (!Array.isArray(parkingMarkers)) {
                parkingMarkers = [];
            }

            parkingMarkers.forEach(marker => marker.setMap(null));
            parkingMarkers = [];
        
            let bounds = new google.maps.LatLngBounds(); // 📍 讓地圖適應所有標記
        
            for (const place of places) {
                let position = place.geometry?.location;
                if (!position || !position.lat || !position.lng) {
                    console.warn("⚠️ 無效的停車場位置:", place);
                    continue;  // 跳過錯誤的資料
                }
        
                let translatedName = await translateText(place.name || "無名稱", "zh-TW");
        
                let marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
                    title: translatedName
                });
        
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/100?text=No+Image";
        
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} 停車場`;
        
                let infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center;">
                            <a href="${googleSearchUrl}" target="_blank">
                                <img src="${photoUrl}" alt="${translatedName}" style="width: 100px; height: 100px; border-radius: 8px;">
                            </a>
                            <br>
                            <strong>
                                <a href="${googleSearchUrl}" target="_blank">${translatedName}</a>
                            </strong>
                        </div>
                    `
                });
        
                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });
        
                parkingMarkers.push(marker);
                bounds.extend(position); // 📍 擴展地圖邊界以包含標記
            }
        
            // 📌 **確保地圖調整至適合的縮放級別**
            if (places.length > 0) {
                map.fitBounds(bounds);
            } else {
                map.setCenter({ lat: centerLat, lng: centerLng });
                map.setZoom(15);
            }
        }
        
        // 🅿️ **在列表顯示停車場資訊（與景點相同格式）**
        async function displayParking(places) {
            let list = document.getElementById("attractionsList");
            let parkingSection = document.createElement("div");
            parkingSection.innerHTML = "<h3>🚗 附近停車場</h3>";
            list.appendChild(parkingSection);
        
            for (const place of places) {
                let originalName = place.name || "無名稱";
                let translatedName = await translateText(originalName, "zh-TW");
                let address = place.vicinity || "地址不詳";
                let rating = place.rating ? `⭐ ${place.rating}` : "⭐ 無評分";
        
                let googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(translatedName)} 停車場`;
        
                let apiKey = window.GOOGLE_API_KEY || "";
                let photoUrl = place.photos && place.photos.length > 0
                    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${apiKey}`
                    : "https://via.placeholder.com/400?text=No+Image";
        
                let li = document.createElement("li");
                li.classList.add("attraction-item");
                li.innerHTML = `
                    <a href="${googleSearchUrl}" target="_blank">
                        <img src="${photoUrl}" alt="${translatedName}" class="attraction-img">
                    </a>
                    <div class="attraction-info">
                        <h3>
                            <a href="${googleSearchUrl}" target="_blank" style="text-decoration: none; color: #007bff;">
                                ${translatedName}
                            </a>
                        </h3>
                        <p>${address}</p>
                        <p>${rating}</p>
                    </div>
                `;
        
                list.appendChild(li);
            }
        }
                // **名稱翻譯**
        async function translateText(text, targetLang = "zh-TW") {
            const response = await fetch(`/api/translate?text=${encodeURIComponent(text)}&target=${targetLang}`);
            const data = await response.json();
            return data.translatedText || text;  // 預防 API 失敗時，仍顯示原始名稱
        }

        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        cookieValue = cookie.substring('csrftoken='.length, cookie.length);
                        break;
                    }
                }
            }
            return cookieValue;
        }


        window.onload = loadGoogleMaps;

    </script>

</body>
</html>